# OpenHands Workspace Isolation Critical Fix

## 📋 Project Overview

This document outlines a critical fix for the OpenHands workspace isolation system. The current implementation fails to provide proper isolation between conversations, causing file contamination and VSCode display issues.

## 🚨 Problem Statement

### Current Issues
1. **File Contamination**: Multiple conversations share the same workspace directory
2. **VSCode Empty Directories**: VSCode points to non-existent paths while files exist elsewhere
3. **Read-Only Filesystem Errors**: `OSError: [Errno 30] Read-only file system: '/workspace'`
4. **CSRF Authentication Failures**: MCP client receives 403 Forbidden errors
5. **Missing Tools**: `str_replace_editor` command not found in containers

### Root Cause Analysis
The fundamental issue is **attempting to create subdirectories inside Docker's read-only `/workspace` mount**:

```
❌ CURRENT BROKEN APPROACH:
Host: ./workspace → Container: /workspace (read-only)
Then try: mkdir /workspace/conversations/{user_id}/{conv_id}/ (FAILS)
Result: Falls back to shared /workspace, causing contamination
```

### Evidence from Logs
```
OSError: [Errno 30] Read-only file system: '/workspace'
CSRF validation failed for /mcp/mcp
str_replace_editor: command not found
```

## ✅ Solution Strategy

**Host-Side Directory Management** - Create isolation through Docker mounting strategy, not container-side operations.

```
✅ NEW APPROACH:
Host: ./workspace/conversations/{user_id}/{conv_id}/ → Container: /workspace
Result: Each container gets isolated /workspace via different host mounts
```

## 📝 Implementation Plan

### Phase 1: Docker Mount Strategy Overhaul (CRITICAL)

#### Files to Modify:
- `openhands/runtime/impl/docker/docker_runtime.py`

#### Changes Required:

**1. Update `_process_volumes()` method:**
```python
def _process_volumes(self) -> dict[str, dict[str, str]]:
    """Create true isolation via host-side directory management."""
    volumes: dict[str, dict[str, str]] = {}

    # Create conversation-specific directory on HOST
    workspace_base = self.config.workspace_mount_path or "./workspace"
    conv_host_dir = os.path.join(
        os.path.abspath(workspace_base),
        "conversations",
        self.user_id or "default",
        self.sid
    )

    # Ensure directory exists with proper permissions
    os.makedirs(conv_host_dir, mode=0o755, exist_ok=True)

    # Mount conversation directory DIRECTLY to /workspace
    volumes[conv_host_dir] = {
        'bind': '/workspace',
        'mode': 'rw'
    }

    self.log('info', f"Isolated workspace: {conv_host_dir} -> /workspace")
    return volumes
```

**2. Handle legacy mounting logic:**
- Ensure the new conversation-specific mounting takes precedence
- Maintain compatibility with existing configuration options

### Phase 2: Code Simplification (HIGH)

#### Files to Modify:
- `openhands/runtime/impl/docker/docker_runtime.py`

#### Components to Remove:

**1. Delete `_create_conversation_workspace()` method entirely:**
```python
# DELETE THIS ENTIRE METHOD - it causes read-only filesystem errors
async def _create_conversation_workspace(self) -> None:
    # This method fails and should be removed
```

**2. Simplify VSCode URL generation:**
```python
@property
def vscode_url(self) -> str | None:
    token = super().get_vscode_token()
    if not token:
        return None
    # Simple /workspace - mount provides isolation
    vscode_url = f'http://localhost:{self._vscode_port}/?tkn={token}&folder=/workspace'
    return vscode_url
```

**3. Remove custom `workspace_root` property override:**
```python
# DELETE THIS PROPERTY - use base implementation
@property
def workspace_root(self) -> Path:
    # Remove this override
```

**4. Update container initialization:**
```python
async def connect(self) -> None:
    # ... existing code ...

    # REMOVE this line (causes read-only filesystem error):
    # await self._create_conversation_workspace()

    # Keep workspace manager initialization:
    await self._init_workspace_manager()
```

### Phase 3: Runtime Integration Updates (HIGH)

#### Files to Modify:
- `openhands/runtime/impl/docker/docker_runtime.py`

#### Changes Required:

**1. Simplify workspace manager initialization:**
```python
async def _init_workspace_manager(self) -> None:
    """Initialize with simplified paths - mount handles isolation."""
    try:
        if not self.config.workspace_storage_type:
            return

        storage = self._get_workspace_storage()

        # Simple /workspace path - mount provides isolation
        self.workspace_manager = WorkspaceManager(
            storage=storage,
            conversation_id=self.sid,
            user_id=self.user_id or 'default',
            workspace_path='/workspace',  # Simplified!
            backup_interval=self.config.workspace_backup_interval,
        )

        await self.workspace_manager.initialize()
```

**2. Maintain S3/MinIO conversation isolation:**
- Keep existing S3 storage paths: `conversations/{user_id}/{conversation_id}/`
- This ensures cloud storage isolation even with simplified container paths

### Phase 4: Additional Bug Fixes (MEDIUM)

#### Files to Modify:
- Various MCP client files
- Runtime container configuration
- Error handling modules

#### Changes Required:

**1. Fix CSRF Token Issues:**
```python
# Add to MCP client headers
headers = {
    'X-CSRFToken': request.cookies.get('csrftoken'),
    'Cookie': request.headers.get('Cookie')
}
```

**2. Ensure Tool Availability:**
- Add `str_replace_editor` to runtime container image
- Implement fallback to `nano`/`vim` when tools missing

**3. Add Error Handling:**
```python
def ensure_workspace_directory(self, conv_host_dir: str) -> bool:
    """Ensure conversation workspace directory exists with proper permissions."""
    try:
        os.makedirs(conv_host_dir, mode=0o755, exist_ok=True)
        return True
    except OSError as e:
        self.log('error', f'Failed to create workspace directory {conv_host_dir}: {e}')
        return False
```

### Phase 5: Cleanup & Maintenance (LOW)

#### Files to Create:
- `openhands/utils/workspace_cleanup.py`

#### Changes Required:

**1. Implement Cleanup Logic:**
```python
def cleanup_old_conversations(base_path: str, max_age_days: int = 7):
    """Clean up old conversation directories."""
    conversations_dir = os.path.join(base_path, "conversations")
    if not os.path.exists(conversations_dir):
        return

    for user_dir in os.listdir(conversations_dir):
        user_path = os.path.join(conversations_dir, user_dir)
        for conv_dir in os.listdir(user_path):
            conv_path = os.path.join(user_path, conv_dir)
            stat = os.stat(conv_path)
            age_days = (time.time() - stat.st_mtime) / 86400
            if age_days > max_age_days:
                shutil.rmtree(conv_path)
                logger.info(f'Cleaned up old conversation: {conv_path}')
```

## 🗂️ Files and Directories Affected

### Primary Files to Modify:
```
openhands/runtime/impl/docker/docker_runtime.py    # Main isolation logic
openhands/storage/workspace/manager.py              # Workspace management
openhands/server/routes/mcp.py                      # CSRF token fixes
openhands/core/config/openhands_config.py          # Configuration updates
```

### Test Files to Update:
```
tests/unit/test_docker_runtime.py                   # Unit tests
tests/integration/test_workspace_isolation.py       # Integration tests
tests/unit/test_workspace_manager.py                # Workspace tests
```

### New Files to Create:
```
openhands/utils/workspace_cleanup.py                # Cleanup utilities
internal_docs/workspace_isolation_architecture.md   # Documentation
```

## 🔍 Testing Strategy

### Unit Tests Required:
1. **Test host directory creation** with various permission scenarios
2. **Test volume mounting logic** with different configurations
3. **Test workspace manager initialization** with simplified paths
4. **Test error handling** for failed directory creation

### Integration Tests Required:
1. **Test complete conversation isolation** between multiple conversations
2. **Test VSCode URL generation** points to correct isolated workspace
3. **Test file operations** remain isolated per conversation
4. **Test S3/MinIO storage** maintains conversation isolation

### Manual Testing Steps:
1. **Create multiple conversations** and verify separate host directories
2. **Check VSCode displays** correct files for each conversation
3. **Verify file operations** don't contaminate other conversations
4. **Test container restart** preserves isolation

## 📊 Success Metrics

### Before Fix (Current State):
- ❌ Multiple conversations share `/workspace`
- ❌ VSCode shows empty directories for new conversations
- ❌ Files contaminate between conversations
- ❌ Read-only filesystem errors in logs

### After Fix (Expected State):
- ✅ Each conversation gets isolated `/workspace` via host mounts
- ✅ VSCode shows correct files for each conversation
- ✅ Zero file contamination between conversations
- ✅ No read-only filesystem errors

## 🚀 Implementation Priority

### Phase 1 - Critical (Week 1):
- [ ] Update Docker volume mounting strategy
- [ ] Remove failing container-side directory creation
- [ ] Test basic isolation functionality

### Phase 2 - High (Week 1-2):
- [ ] Simplify code paths and remove complex logic
- [ ] Update VSCode URL generation
- [ ] Update workspace manager initialization

### Phase 3 - High (Week 2):
- [ ] Maintain S3/MinIO conversation isolation
- [ ] Update all integration points
- [ ] Comprehensive testing

### Phase 4 - Medium (Week 3):
- [ ] Fix CSRF token issues
- [ ] Ensure tool availability
- [ ] Add proper error handling

### Phase 5 - Low (Week 4):
- [ ] Implement cleanup utilities
- [ ] Add monitoring and logging
- [ ] Documentation updates

## 🔧 Technical Architecture

### Current Architecture (Broken):
```
Host: ./workspace → Container: /workspace (read-only mount)
├── Container tries: mkdir /workspace/conversations/{user}/{conv}/ ❌
├── Falls back to: /workspace (shared) ❌
└── VSCode points to: /workspace/conversations/{user}/{conv}/ (empty) ❌
```

### New Architecture (Fixed):
```
Host: ./workspace/conversations/{user}/{conv}/ → Container: /workspace (rw mount)
├── Each container gets isolated /workspace ✅
├── Files isolated per conversation ✅
└── VSCode points to: /workspace (with correct files) ✅
```

## 📝 Additional Notes

### Dependencies:
- Docker volume mounting capabilities
- Host filesystem read-write permissions
- S3/MinIO storage configuration
- CSRF token handling in web framework

### Risks and Mitigations:
1. **Risk**: Host directory permission issues
   **Mitigation**: Proper error handling and fallback strategies

2. **Risk**: Legacy configuration compatibility
   **Mitigation**: Maintain backward compatibility during transition

3. **Risk**: Performance impact of multiple mounts
   **Mitigation**: Monitor performance and optimize if needed

### Rollback Plan:
1. Revert Docker runtime changes
2. Restore original mounting logic
3. Re-enable container-side directory creation (with known issues)

## 🤝 Contributor Guidelines

### Before Starting:
1. Read this entire document
2. Understand the root cause and solution strategy
3. Set up local development environment with Docker
4. Run existing tests to establish baseline

### During Development:
1. Follow the phase-by-phase implementation plan
2. Test each change thoroughly before proceeding
3. Update tests as you modify code
4. Document any deviations from the plan

### Before Submitting:
1. Run complete test suite
2. Test manually with multiple conversations
3. Verify no regression in existing functionality
4. Update documentation if needed

---

**Last Updated**: 2025-01-02
**Status**: Planning Phase
**Priority**: Critical
**Estimated Effort**: 2-4 weeks
**Risk Level**: Medium (well-understood problem with clear solution)

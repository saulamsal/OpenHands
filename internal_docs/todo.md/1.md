# Conversation System Improvements Plan

## Current State Analysis

1. **Sidebar Implementation**
   - Using `EnhancedSidebar` component (not regular `sidebar.tsx`)
   - Sidebar shows conversations as a panel when clicked
   - No separate conversations route exists

2. **Team Context**
   - Auth context already manages active team and persists to localStorage
   - Database model `ConversationDB` has `team_id` field
   - But `ConversationMetadata` dataclass is missing `team_id` field
   - Conversations are not filtered by team

3. **Current Issues**
   - Conversations list opens as a panel, not a route
   - All conversations shown regardless of active team
   - New conversations don't get associated with current team

## Required Changes

### 1. Create Conversations Page Route (/conversations)
   - Create new route file: `frontend/src/routes/conversations.tsx`
   - Move conversation list logic from panel to dedicated page
   - Update sidebar button to navigate to route instead of opening panel

### 2. Add Team ID to ConversationMetadata
   - Add `team_id: str | None = None` field to ConversationMetadata dataclass
   - Update conversation creation to include active team ID
   - Update database queries to filter by team_id

### 3. Update Frontend API Calls
   - Modify `createConversation` to accept and pass team_id
   - Update `useUserConversations` hook to filter by active team
   - Pass active team ID from auth context when creating conversations

### 4. Update Backend API
   - Modify `InitSessionRequest` to include optional team_id field
   - Update `create_new_conversation` to accept and store team_id
   - Ensure conversation queries filter by team_id

### 5. Clean Up Sidebar Implementation
   - Remove unused `sidebar.tsx` file (only keep `enhanced-sidebar.tsx`)
   - Update any remaining references to old sidebar

### 6. Implement Team-Scoped Conversation Filtering
   - Update conversation list queries to include team_id filter
   - Show only conversations belonging to active team
   - Handle personal team (default) vs other teams

## Implementation Order

1. **Phase 1: Add team_id to data models**
   - Update ConversationMetadata dataclass
   - Update API request/response models
   - Update conversation creation flow

2. **Phase 2: Create conversations route**
   - Create new route component
   - Move panel logic to route
   - Update navigation

3. **Phase 3: Implement team filtering**
   - Update queries to filter by team
   - Pass team context through API calls
   - Test team switching

4. **Phase 4: Cleanup**
   - Remove old sidebar file
   - Update tests
   - Verify all functionality

## Key Files to Modify

### Frontend
- `frontend/src/routes/conversations.tsx` (create new)
- `frontend/src/components/features/sidebar/enhanced-sidebar.tsx`
- `frontend/src/components/shared/buttons/conversation-panel-button.tsx`
- `frontend/src/hooks/mutation/use-create-conversation.ts`
- `frontend/src/hooks/query/use-user-conversations.ts`
- `frontend/src/api/open-hands.ts`

### Backend
- `openhands/storage/data_models/conversation_metadata.py`
- `openhands/server/routes/manage_conversations.py`
- `openhands/server/services/conversation_service.py`
- `openhands/storage/database/stores/conversation.py`

## Success Criteria

1.  Clicking conversations in sidebar navigates to `/conversations` route
2.  Conversations are filtered by active team
3.  New conversations are created with current team_id
4.  Switching teams shows different conversation lists
5.  Old sidebar.tsx file is removed
6.  All tests pass